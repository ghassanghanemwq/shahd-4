<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shahd 4 â€” Ultra UI</title>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.161.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.161.0/examples/jsm/"
  }
}
</script>

<style>
  :root{
    --bg:#ffffff; --text:#0b0b10; --muted:#6c6c78; --edge:#e7e7ec;
    --primary:#8B0E2A; --primary-2:#A01832;
    --available:#f3f3f0; 
    --reserved:#0047AB;  /* dark blue for reserved */
    --sold:#df1a25; 
    --selected:#22c55e;
  }

  html,body{
    height:100%;
    margin:0;
    background:var(--bg);
    color:var(--text);
    font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial
  }
  #scene{position:fixed;inset:0;background:var(--bg)}
  canvas{display:block;width:100%;height:100%}

  /* brand */
  #brand{
    position:fixed;
    left:12px;top:12px;
    z-index:12;
    display:flex;
    align-items:center;
    gap:10px
  }
  #brand img{height:34px;display:block}
  @media (max-width:600px){ #brand img{height:26px} }

  /* top-right menu (single source of truth) */
  #menu{
    position:fixed;
    right:12px;top:12px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:42px;height:42px;
    border-radius:12px;
    border:1px solid #ececf3;
    background:#fff;
    cursor:pointer;
    box-shadow:0 6px 16px rgba(0,0,0,.05);
    z-index:13
  }
  #menu.hidden{display:none}

  /* search */
  #topbar{
    position:fixed;
    inset:12px 72px auto 72px;
    display:flex;
    justify-content:center;
    z-index:12
  }
  #search{
    width:min(560px,100%);
    padding:12px 14px;
    border-radius:12px;
    border:1px solid #e6e6ee;
    background:#fff;
    color:#111;
    outline:none;
    box-shadow:0 0 0 0 rgba(139,14,42,0),0 12px 24px rgba(0,0,0,.05);
    transition:box-shadow .2s ease,border-color .2s ease
  }
  #search::placeholder{color:#9aa}
  #search:focus{
    border-color:#d7d7e2;
    box-shadow:0 0 0 3px rgba(160,24,50,.08),0 12px 30px rgba(0,0,0,.06)
  }
  #results{
    position:absolute;
    top:54px;
    width:min(560px,calc(100% - 24px));
    background:#fff;
    border:1px solid #e8e8f0;
    border-radius:12px;
    overflow:auto;
    max-height:42vh;
    box-shadow:0 22px 40px rgba(0,0,0,.08);
    display:none
  }
  .result{
    display:flex;
    align-items:center;
    gap:10px;
    padding:12px 14px;
    cursor:pointer;
    color:#111
  }
  .result:hover{background:#fafafa}
  .badge{
    font-size:11px;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid #eee;
    color:#333;
    background:#f8f8ff;
    margin-left:auto
  }

  /* labels */
  #label{
    position:fixed;
    pointer-events:none;
    transform:translate(-50%,-120%);
    padding:6px 10px;
    background:rgba(0,0,0,.78);
    border:1px solid rgba(0,0,0,.1);
    border-radius:8px;
    color:#fff;
    font-weight:700;
    font-size:12px;
    box-shadow:0 8px 30px rgba(0,0,0,.15);
    display:none;
    z-index:8
  }
  .lotLabel{
    position:absolute;
    padding:2px 6px;
    border:1px solid rgba(0,0,0,.1);
    border-radius:6px;
    background:rgba(255,255,255,.86);
    color:#111;
    font-weight:700;
    font-size:11px;
    letter-spacing:.02em;
    pointer-events:none;
    user-select:none;
    white-space:nowrap;
    backdrop-filter:blur(2px);
    transition:opacity .18s linear
  }

  /* bottom bar (legend + centered HUD + lights) */
  #bottomBar{
    position:fixed;
    left:10px;right:10px;bottom:10px;
    display:grid;
    grid-template-columns:1fr auto 1fr;
    align-items:end;
    z-index:9
  }
  #legend{
    display:flex;
    gap:8px;
    justify-self:start
  }
  .chip{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    background:#fff;
    border:1px solid var(--edge);
    color:#222
  }
  .chip::before{
    content:'';
    width:8px;height:8px;
    border-radius:50%
  }
  .chip.avail::before{background:var(--available)}
  .chip.resv::before{background:var(--reserved)}  /* dark blue legend */
  .chip.sold::before{background:var(--sold)}
  #hud{position:static;justify-self:center}
  #hud .help{
    padding:8px 14px;
    border-radius:999px;
    background:#fff;
    border:1px solid var(--edge);
    font-size:12px;
    color:#222;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
    opacity:.96
  }
  #lights{justify-self:end;display:flex;gap:8px}
  .iconBtn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:40px;height:40px;
    border-radius:12px;
    border:1px solid var(--edge);
    background:#fff;
    cursor:pointer;
    box-shadow:0 4px 12px rgba(0,0,0,.05)
  }
  .iconBtn[aria-pressed="true"]{outline:3px solid rgba(160,24,50,.12)}

  /* drawer */
  #drawer{
    position:fixed;
    top:0;right:0;bottom:0;
    width:min(400px,88vw);
    background:#fff;
    border-left:1px solid #ececf3;
    box-shadow:-10px 0 28px rgba(0,0,0,.06);
    transform:translateX(100%);
    transition:transform .42s cubic-bezier(.22,.8,.2,1);
    z-index:10;
    overflow:auto
  }
  #drawer.open{transform:translateX(0)}
  #drawer header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:14px 16px;
    border-bottom:1px solid #f0f0f6;
    position:sticky;
    top:0;
    background:#fff
  }
  #drawer header .title{
    font-weight:800;
    letter-spacing:.02em;
    color:#111
  }
  #drawerToggle{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:36px;height:36px;
    border-radius:10px;
    border:1px solid #ececf3;
    background:#fff;
    cursor:pointer
  }
  #drawerToggle svg{pointer-events:none}
  #content{padding:16px}
  .row{
    display:grid;
    grid-template-columns:110px 1fr;
    gap:10px;
    margin:10px 0
  }
  .muted{color:#666}
  .ghost{
    width:100%;
    padding:12px 14px;
    border:1px solid #e9e9f2;
    border-radius:12px;
    background:#fff;
    color:#111;
    font-weight:700;
    cursor:pointer
  }
  .primary{
    width:100%;
    padding:12px 14px;
    border:0;
    border-radius:12px;
    background:linear-gradient(180deg,var(--primary),var(--primary-2));
    color:#fff;
    font-weight:900;
    cursor:pointer;
    box-shadow:0 12px 30px rgba(139,14,42,.15);
    text-transform:uppercase;
    letter-spacing:.03em
  }

  /* veil */
  #veil{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.0);
    backdrop-filter:none;
    z-index:9;
    opacity:0;
    pointer-events:none;
    transition:opacity .28s ease, backdrop-filter .28s ease
  }
  #veil.on{
    opacity:1;
    background:rgba(0,0,0,.18);
    backdrop-filter:blur(1.5px);
    pointer-events:auto
  }

  /* loader */
  #loading{
    position:absolute;
    inset:0;
    display:grid;
    place-items:center;
    color:#777;
    letter-spacing:.2em;
    text-transform:uppercase;
    z-index:11
  }
</style>
</head>
<body>
  <!-- brand -->
  <a id="brand" href="#" aria-label="Brand">
    <img src="svg-01.svg" alt="Brand logo" />
  </a>

  <!-- single top-right burger -->
  <button id="menu" aria-label="Open details">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M4 7h16M4 12h16M4 17h16" stroke="#8B0E2A" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>

  <!-- search -->
  <div id="topbar">
    <input id="search" placeholder="Search lot (e.g. 012 or Lot_012)" />
    <div id="results"></div>
  </div>

  <!-- scene -->
  <div id="scene">
    <div id="loading">LOADINGâ€¦ 0%</div>
    <canvas id="c"></canvas>
    <div id="label"></div>
  </div>

  <!-- bottom bar -->
  <div id="bottomBar">
    <div id="legend">
      <span class="chip avail">Available</span>
      <span class="chip resv">Reserved</span>
      <span class="chip sold">Sold</span>
    </div>
    <div id="hud">
      <div class="help">LMB rotate â€¢ RMB pan â€¢ Wheel zoom</div>
    </div>
    <div id="lights">
      <!-- Night toggle only -->
      <button class="iconBtn" id="night" aria-pressed="false" title="Night mode">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M15 3a7.5 7.5 0 1 0 6 12A9 9 0 0 1 15 3z" stroke="#111" stroke-width="1.5"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- veil + drawer -->
  <div id="veil"></div>
  <aside id="drawer" aria-label="Parcel details">
    <header>
      <div class="title">Parcel Details</div>
      <button id="drawerToggle" title="Close panel" aria-label="Close panel">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 6l12 12M18 6l-12 12" stroke="#8B0E2A" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </header>
    <div id="content">
      <p class="muted">Tap a lot or use search.</p>
      <div class="row"><div class="muted">Lot</div><div id="lotId">â€”</div></div>
      <div class="row"><div class="muted">Area</div><div id="area">â€”</div></div>
      <div class="row"><div class="muted">Length</div><div id="length">â€”</div></div>
      <div class="row"><div class="muted">Width</div><div id="width">â€”</div></div>
      <div class="row"><div class="muted">Price</div><div id="price">â€”</div></div>
      <div class="row"><div class="muted">Status</div><div id="status"><span class="chip">â€”</span></div></div>
      <div class="row"><div class="muted">Description</div><div id="notes">â€”</div></div>
      <div class="row" style="grid-template-columns:1fr 1fr">
        <button id="brochureBtn" class="ghost">Open Brochure</button>
        <button id="inquireBtn" class="primary">Inquire</button>
      </div>
    </div>
  </aside>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
import { KTX2Loader } from 'three/addons/loaders/KTX2Loader.js';
import { MeshoptDecoder } from 'three/addons/libs/meshopt_decoder.module.js';
import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { SMAAPass } from 'three/addons/postprocessing/SMAAPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

/* ========= CONFIG ========= */
const CONFIG = { glbUrl:'./map.glb', highlight:0x8B0E2A };

/* ========= DATA ========= */
let RAW = {}, LOTS = {}, INDEX = [];
fetch('lots.json')
  .then(r=>r.json())
  .then(d=>{ RAW=d||{}; normalize(); })
  .catch(()=>{});

/* ========= DOM ========= */
const canvas = document.getElementById('c');
const loading = document.getElementById('loading');
const label   = document.getElementById('label');
const drawer  = document.getElementById('drawer');
const veil    = document.getElementById('veil');
const drawerToggle = document.getElementById('drawerToggle');
const menuBtn = document.getElementById('menu');
const lotIdEl = document.getElementById('lotId');
const areaEl  = document.getElementById('area');
const lengthEl = document.getElementById('length');
const widthEl  = document.getElementById('width');
const priceEl = document.getElementById('price');
const statusEl= document.getElementById('status');
const notesEl = document.getElementById('notes');
const brochureBtn = document.getElementById('brochureBtn');
const inquireBtn  = document.getElementById('inquireBtn');
const search  = document.getElementById('search');
const results = document.getElementById('results');
const btnNight = document.getElementById('night');

/* ========= DRAWER OPEN/CLOSE ========= */
function toggleDrawer(force){
  const toOpen = force !== undefined ? force : !drawer.classList.contains('open');
  drawer.classList.toggle('open', toOpen);
  veil.classList.toggle('on', toOpen);
  menuBtn.classList.toggle('hidden', toOpen);
}
if (menuBtn)      menuBtn.addEventListener('click', () => toggleDrawer(true));
if (drawerToggle) drawerToggle.addEventListener('click', () => toggleDrawer(false));
if (veil)         veil.addEventListener('click', () => toggleDrawer(false));
window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ toggleDrawer(false); } });

// swipe-right to close
(() => {
  let startX = 0, startY = 0, active = false;
  drawer.addEventListener('touchstart', (e)=>{
    if (!drawer.classList.contains('open')) return;
    const t = e.changedTouches[0];
    startX = t.clientX; startY = t.clientY; active = true;
  }, {passive:true});
  drawer.addEventListener('touchmove', (e)=>{
    if(!active) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - startX;
    const dy = Math.abs(t.clientY - startY);
    if (dx > 60 && dy < 40){ active = false; toggleDrawer(false); }
  }, {passive:true});
  drawer.addEventListener('touchend', ()=> active=false, {passive:true});
})();

/* ========= THREE ========= */
const renderer = new THREE.WebGLRenderer({canvas, antialias:true, powerPreference:'high-performance'});
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(innerWidth, innerHeight);
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.0;
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;

const scene = new THREE.Scene();
const pmrem = new THREE.PMREMGenerator(renderer);
const roomEnv = pmrem.fromScene(new RoomEnvironment(renderer), 0.03).texture;
scene.environment = roomEnv;

const camera = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.1, 4000);
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.maxPolarAngle = Math.PI * 0.49;
controls.minPolarAngle = 0.28;
controls.enablePan = true;
controls.dampingFactor = 0.06;
controls.mouseButtons = {
  LEFT: THREE.MOUSE.ROTATE,
  MIDDLE: THREE.MOUSE.DOLLY,
  RIGHT: THREE.MOUSE.PAN
};

const key = new THREE.DirectionalLight(0xffffff,1.15);
key.position.set(2,5,2);
key.castShadow=true;
scene.add(key);
const rim = new THREE.DirectionalLight(0xffffff,0.24);
rim.position.set(-2,6,-4);
rim.castShadow=true;
scene.add(rim);
scene.add(new THREE.AmbientLight(0xffffff,0.45));

const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(4000,4000),
  new THREE.MeshStandardMaterial({color:0xffffff, roughness:.9, metalness:0})
);
ground.rotation.x = -Math.PI/2;
ground.position.y=-0.02;
ground.receiveShadow = true;
scene.add(ground);

// post fx
const composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
composer.addPass(new SMAAPass(innerWidth*renderer.getPixelRatio(), innerHeight*renderer.getPixelRatio()));
const bloom = new UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 0.35, 0.85, 0.2);
bloom.threshold = 0.86;
bloom.strength = 0.06;
bloom.radius = 0.14;
composer.addPass(bloom);

// CSS2D labels
const labelRenderer = new CSS2DRenderer();
labelRenderer.setSize(innerWidth, innerHeight);
labelRenderer.domElement.style.position = 'fixed';
labelRenderer.domElement.style.inset = '0';
labelRenderer.domElement.style.pointerEvents = 'none';
document.body.appendChild(labelRenderer.domElement);

const ray = new THREE.Raycaster();
const mouse = new THREE.Vector2();
let GLB, hoveredLotId=null, selectedLotId=null;
const LOT_LABELS = new Map();
const LOT_MESHES = new Map();

/* helpers */
const pad3 = n => String(n).padStart(3,'0');
const normId = n => `Lot_${pad3(n)}`;
function extractLotNumber(name){
  if(!name) return null;
  const base = String(name).split(/[\\/|]/).pop().replace(/\.+\d+$/,'');
  const m = base.match(/lot[\s_\-]*0*(\d{1,4})/i);
  return m ? m[1] : null;
}
function getLotIdFromObjectName(name){
  const n = extractLotNumber(name);
  return n ? normId(n) : null;
}

function fit(root){
  const box = new THREE.Box3().setFromObject(root);
  const c = box.getCenter(new THREE.Vector3());
  const s = box.getSize(new THREE.Vector3());
  const r = Math.max(s.x,s.y,s.z)*0.6;
  const dir = new THREE.Vector3(1,0.8,1).normalize();
  camera.position.copy(c.clone().add(dir.multiplyScalar(r*2.3)));
  controls.target.copy(c);
  controls.minDistance=r*0.2;
  controls.maxDistance=r*10;
  camera.near=Math.max(0.1,r/100);
  camera.far=r*100;
  camera.updateProjectionMatrix();
  controls.update();
}

function pick(x,y){
  mouse.set((x/canvas.clientWidth)*2-1, -(y/canvas.clientHeight)*2+1);
  ray.setFromCamera(mouse, camera);
  const hits = ray.intersectObjects(GLB?GLB.children:[], true);
  for(const h of hits){
    const id = getLotIdFromObjectName(h.object?.name||'');
    if(id) return id;
  }
  return null;
}

function normalize(){
  LOTS = {};
  INDEX = [];
  const seen = new Set();
  for(const [k,v] of Object.entries(RAW)){
    if(/^Lot_\d{3,4}$/.test(k)){
      LOTS[k] = {
        area: v.Area ?? null,
        unit: 'mÂ²',
        length: v.Length ?? null,
        width: v.Width ?? null,
        price: v.Price ?? null,
        status: v.Status ? String(v.Status).toLowerCase() : null,
        notes: v.Description ?? null,
        brochure:v.brochure,
        link:v.link
      };
      if(!seen.has(k)){ INDEX.push({id:k}); seen.add(k); }
    }
  }
  if(GLB){
    GLB.traverse(o=>{
      if(!o.isMesh || !o.name) return;
      const id = getLotIdFromObjectName(o.name);
      if(!id) return;
      if(!seen.has(id)){ INDEX.push({id}); seen.add(id); }
    });
  }
  INDEX.sort((a,b)=>a.id.localeCompare(b.id,undefined,{numeric:true}));
}

function openDrawer(){ toggleDrawer(true); }
function closeDrawer(){ toggleDrawer(false); }

function setMeshesColor(meshes, cssColor){
  meshes.forEach(m=>{
    m.userData = m.userData || {};
    if (m.userData._origColor === undefined && m.material?.color) {
      m.userData._origColor = m.material.color.getHex();
    }
    if (m.material?.color) m.material.color.set(cssColor);
  });
}
function restoreMeshesColor(meshes){
  meshes.forEach(m=>{
    if (m.userData && m.userData._origColor !== undefined && m.material?.color) {
      m.material.color.setHex(m.userData._origColor);
    }
    if (m.material?.emissive){
      m.material.emissive.set(0);
      m.material.emissiveIntensity = 0;
    }
  });
}

function setLotHover(lotId){
  if(hoveredLotId === lotId) return;
  if(hoveredLotId && hoveredLotId !== selectedLotId){
    const prev = LOT_MESHES.get(hoveredLotId) || [];
    prev.forEach(m=>{
      m.material?.emissive?.set(0);
      m.material.emissiveIntensity=0;
    });
  }
  hoveredLotId = lotId;
  if(hoveredLotId && hoveredLotId !== selectedLotId){
    const ms = LOT_MESHES.get(hoveredLotId) || [];
    ms.forEach(m=>{
      m.material?.emissive?.setHex(CONFIG.highlight);
      m.material.emissiveIntensity = .10;
    });
  }
}

function setLotSelected(lotId){
  if(selectedLotId && selectedLotId !== lotId){
    restoreMeshesColor(LOT_MESHES.get(selectedLotId) || []);
  }
  selectedLotId = lotId;
  const meshes = LOT_MESHES.get(lotId) || [];
  const selCSS = getComputedStyle(document.documentElement).getPropertyValue('--selected').trim() || '#22c55e';
  setMeshesColor(meshes, selCSS);
  meshes.forEach(m=>{
    m.material?.emissive?.setHex(CONFIG.highlight);
    m.material.emissiveIntensity = .22;
    m.castShadow = true;
  });
  if (lotId){
    openDrawer();
    showDetails(lotId);
  }
}

function showDetails(idOrName){
  const n = extractLotNumber(idOrName) || extractLotNumber(String(idOrName));
  const display = n ? normId(n) : idOrName;
  const d = LOTS[display] || null;

  lotIdEl.textContent = display.replace(/^lot_/i,'');
  areaEl.textContent  = d?.area ? `${Number(d.area).toLocaleString()} ${d.unit||'mÂ²'}` : 'â€”';
  lengthEl.textContent = d?.length ? `${Number(d.length).toLocaleString()} m` : 'â€”';
  widthEl.textContent  = d?.width ? `${Number(d.width).toLocaleString()} m` : 'â€”';
  priceEl.textContent = (typeof d?.price === 'number')
    ? `JOD ${Math.round(Number(d.price)).toLocaleString('en-JO')}`
    : 'â€”';

  const s = d?.status || '';
  const chip=document.createElement('span');
  chip.className='chip '+(
    s.startsWith('ava') ? 'avail' :
    s.startsWith('res') ? 'resv' :
    s.startsWith('sold')? 'sold' : ''
  );
  chip.textContent = s ? s[0].toUpperCase()+s.slice(1) : 'â€”';
  statusEl.innerHTML='';
  statusEl.appendChild(chip);
  notesEl.textContent = d?.notes || 'â€”';

  brochureBtn.onclick = ()=> d?.brochure ? window.open(d.brochure,'_blank') : null;
  inquireBtn.onclick  = ()=> d?.link
    ? window.open(d.link,'_blank')
    : window.open('mailto:sales@example.com?subject=Inquiry%20'+encodeURIComponent(display));
}

function buildLotMeshesAndLabels(){
  LOT_LABELS.forEach(({node})=> node.parent?.remove(node));
  LOT_LABELS.clear();
  LOT_MESHES.clear();
  const unions = new Map();
  GLB.traverse(o=>{
    if(!o.isMesh || !o.name) return;
    const n = extractLotNumber(o.name);
    if(!n) return;
    const id = normId(n);
    o.name = id;
    const arr = LOT_MESHES.get(id) || [];
    arr.push(o);
    LOT_MESHES.set(id, arr);
    if(!o.material || !('color' in o.material)){
      o.material = new THREE.MeshStandardMaterial({color:0xf3f3f0, metalness:.06, roughness:.6});
    }
    o.castShadow = true;
    o.receiveShadow = true;
    const box = new THREE.Box3().setFromObject(o);
    const u = unions.get(id) || new THREE.Box3();
    u.union(box);
    unions.set(id, u);
  });

  unions.forEach((box, id)=>{
    const center = box.getCenter(new THREE.Vector3());
    const size = box.getSize(new THREE.Vector3());
    const el = document.createElement('div');
    el.className = 'lotLabel';
    el.textContent = id.replace('Lot_','');
    const css = new CSS2DObject(el);
    css.position.set(center.x, center.y + Math.max(size.y*0.05, 1.0), center.z);
    scene.add(css);
    LOT_LABELS.set(id, { node: css, center });
  });
}

function recolorByStatus(){
  const styles   = getComputedStyle(document.documentElement);
  const offWhite = styles.getPropertyValue('--available').trim() || '#f3f3f0';
  const reserved = styles.getPropertyValue('--reserved').trim()  || '#0047AB';
  const sold     = styles.getPropertyValue('--sold').trim()      || '#df1a25';

  LOT_MESHES.forEach((meshes, id)=>{
    const d = LOTS[id] || {};
    const s = (d.status||'').toLowerCase();
    let base = offWhite;
    if(s.startsWith('sold')) base = sold;
    else if(s.startsWith('res')) base = reserved;   // ðŸ”µ dark blue from CSS var
    meshes.forEach(o=>{
      const mat = (o.material && o.material.clone()) || new THREE.MeshStandardMaterial();
      mat.color.set(base);
      mat.metalness = 0.1;
      mat.roughness = 0.5;
      o.material = mat;
    });
  });
}

function updateLabelOpacity(){
  const d = camera.position.distanceTo(controls.target);
  const t0 = 15, t1 = 40;
  const k = THREE.MathUtils.clamp((d - t0) / (t1 - t0), 0, 1);
  const opacity = 0.2 + 0.8 * k;
  LOT_LABELS.forEach(({node})=>{
    if(node.element) node.element.style.opacity = String(opacity);
  });
}

/* ========= LOAD GLB ========= */
const resolvedGLB = new URL(CONFIG.glbUrl, location.href).href;
const manager = new THREE.LoadingManager();
manager.onStart = ()=>{ loading.textContent = 'Loadingâ€¦ 0%'; };
manager.onError = (url)=>{ console.warn('Asset failed:', url); };
let progressTimer = setTimeout(()=>{
  loading.textContent = 'Still loadingâ€¦ Check that\n\nâ€¢ "map.glb" is next to this HTML\nâ€¢ Using http(s) not file://\nâ€¢ No ad-block/firewall is blocking loaders';
}, 6000);

function createLoader(withExtras=true){
  const L = new GLTFLoader(manager);
  if(withExtras){
    const draco = new DRACOLoader();
    draco.setDecoderPath('https://unpkg.com/three@0.161.0/examples/jsm/libs/draco/');
    L.setDRACOLoader(draco);
    L.setKTX2Loader(
      new KTX2Loader()
        .setTranscoderPath('https://unpkg.com/three@0.161.0/examples/jsm/libs/basis/')
        .detectSupport(renderer)
    );
    L.setMeshoptDecoder(MeshoptDecoder);
  }
  return L;
}
function startRender(){
  render();
  requestAnimationFrame(()=>loading.remove());
  clearTimeout(progressTimer);
}
function loadGLB(url){
  const loaderA = createLoader(true);
  loaderA.load(url, (gltf)=>{
    GLB=gltf.scene;
    afterGLBLoaded();
  }, onProgress, (err)=>{
    console.warn('Primary load failed, retrying without KTX2/Dracoâ€¦', err);
    const loaderB = createLoader(false);
    loaderB.load(url, (gltf)=>{
      GLB=gltf.scene;
      afterGLBLoaded();
    }, onProgress, (err2)=>{
      console.error('Failed to load GLB.', err2);
      loading.textContent = 'Failed to load GLB. Check console.';
    });
  });
}
function onProgress(ev){
  const pct = ev && ev.total ? Math.floor((ev.loaded/ev.total)*100) : 0;
  loading.textContent = 'Loadingâ€¦ ' + pct + '%';
}
function afterGLBLoaded(){
  scene.add(GLB);
  GLB.traverse(o=>{
    if(o.isMesh){
      o.castShadow = true;
      o.receiveShadow = true;
      if(o.material?.map){
        o.material.map.anisotropy = Math.min(16, renderer.capabilities.getMaxAnisotropy());
      }
    }
  });
  fit(GLB);
  buildLotMeshesAndLabels();
  normalize();
  recolorByStatus();
  startRender();
}
try { loadGLB(resolvedGLB); }
catch(e){ console.error(e); loading.textContent='Failed to start loader. See console.'; }

/* ========= INTERACTION ========= */
canvas.addEventListener('mousemove', e=>{
  const lotId = pick(e.clientX, e.clientY);
  setLotHover(lotId);
  if(lotId){
    const n = extractLotNumber(lotId);
    label.textContent = n ? `Lot ${pad3(n)}` : lotId;
    label.style.left = e.clientX+'px';
    label.style.top  = e.clientY+'px';
    label.style.display='block';
  } else {
    label.style.display='none';
  }
});
canvas.addEventListener('mouseleave', ()=>{
  setLotHover(null);
  label.style.display='none';
});
canvas.addEventListener('click', e=>{
  const lotId = pick(e.clientX,e.clientY);
  if(lotId) focusLot(lotId);
  else      deselect();
});

canvas.addEventListener('touchend', e=>{
  if(!pick(e.changedTouches[0].clientX, e.changedTouches[0].clientY)) {
    deselect();
  }
},{passive:true});

window.addEventListener('resize', ()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
  composer.setSize(innerWidth,innerHeight);
  labelRenderer.setSize(innerWidth, innerHeight);
});

controls.addEventListener('change', ()=>{
  const d = camera.position.distanceTo(controls.target);
  renderer.toneMappingExposure = THREE.MathUtils.clamp(1.12 - d * 0.01, 0.9, 1.25);
  updateLabelOpacity();
});

/* ========= SEARCH ========= */
function searchLots(q){
  q=(q||'').trim().toLowerCase();
  if(!q) return [];
  const num=q.replace(/[^0-9]/g,'');
  return INDEX.filter(it=>{
    const id=it.id.toLowerCase();
    const label=id.replace(/^lot_/,'');
    const notes=(RAW[it.id]?.Description||'').toLowerCase();
    return id.includes(q) || (num && label.includes(num)) || notes.includes(q);
  });
}
function showResults(items){
  results.innerHTML='';
  if(!items.length){
    results.style.display='none';
    return;
  }
  for(const it of items.slice(0,12)){
    const row=document.createElement('div');
    row.className='result';
    row.innerHTML=`<strong>${it.id.replace(/^lot_/i,'Lot ')}</strong>`;
    const v = RAW[it.id]||{};
    const b=document.createElement('span');
    b.className='badge';
    b.textContent=(v.Status||'').toString().toUpperCase()||'â€”';
    row.appendChild(b);
    row.onclick=()=>{
      focusLot(it.id);
      results.style.display='none';
    };
    results.appendChild(row);
  }
  results.style.display='block';
}
const debounce=(fn,ms=120)=>{
  let t;
  return (...a)=>{
    clearTimeout(t);
    t=setTimeout(()=>fn(...a),ms);
  };
};
const debouncedShow=debounce(()=> showResults(searchLots(search.value)), 140);
search.addEventListener('input', debouncedShow);
let selIndex=-1;
search.addEventListener('keydown', (e)=>{
  const items=[...results.querySelectorAll('.result')];
  if(e.key==='Escape'){
    e.preventDefault();
    search.value='';
    results.style.display='none';
    selIndex=-1;
    search.blur();
    return;
  }
  if(e.key==='ArrowDown'){
    e.preventDefault();
    if(!items.length) return;
    selIndex=(selIndex+1)%items.length;
    items.forEach((el,i)=>el.style.background=i===selIndex?'#fafafa':'' );
  } else if(e.key==='ArrowUp'){
    e.preventDefault();
    if(!items.length) return;
    selIndex=(selIndex-1+items.length)%items.length;
    items.forEach((el,i)=>el.style.background=i===selIndex?'#fafafa':'' );
  } else if(e.key==='Enter'){
    e.preventDefault();
    if(items.length && selIndex>=0){
      items[selIndex].click();
      selIndex=-1;
      return;
    }
    const v=search.value.trim();
    const m=v.match(/\d{1,4}/);
    const id = m?normId(m[0]):v.replace(/\s+/g,'_');
    focusLot(id);
    results.style.display='none';
  }
});

document.addEventListener('click', (e)=>{
  if(!results.contains(e.target) && e.target!==search) {
    results.style.display='none';
    selIndex=-1;
  }
});

/* ========= FOCUS / DESELECT ========= */
function focusLot(idOrName){
  const n = extractLotNumber(idOrName);
  const lotId = n ? normId(n) : (getLotIdFromObjectName(idOrName) || idOrName);
  const info = LOT_LABELS.get(lotId);
  if(info){
    const c = info.center;
    controls.target.copy(c);
    camera.position.copy(
      c.clone().add(new THREE.Vector3(1,0.85,1).normalize().multiplyScalar(18))
    );
    controls.update();
    setLotSelected(lotId);
    return;
  }
  const ms = LOT_MESHES.get(lotId);
  if(!ms || !ms.length){
    alert('Lot not found: '+lotId);
    return;
  }
  const box=new THREE.Box3();
  ms.forEach(m=>box.union(new THREE.Box3().setFromObject(m)));
  const c=box.getCenter(new THREE.Vector3());
  const s=box.getSize(new THREE.Vector3()).length();
  controls.target.copy(c);
  camera.position.copy(
    c.clone().add(new THREE.Vector3(1,0.85,1).normalize().multiplyScalar(Math.max(6, s*1.8)))
  );
  controls.update();
  setLotSelected(lotId);
}

function deselect(){
  if(selectedLotId){
    restoreMeshesColor(LOT_MESHES.get(selectedLotId) || []);
    selectedLotId=null;
  }
  closeDrawer();
}

/* ========= NIGHT MODE ========= */
const GROUND_DAY = 0xffffff;
const GROUND_NIGHT = 0x000000;
let isNight = false;
function applyNight(on){
  isNight = on;
  btnNight.setAttribute('aria-pressed', String(on));
  key.intensity = on ? 0.4 : 1.15;
  rim.intensity = on ? 0.55 : 0.24;
  renderer.toneMappingExposure = on ? 0.9 : 1.05;
  bloom.strength = on ? 0.10 : 0.06;
  ground.material.color.set(on ? GROUND_NIGHT : GROUND_DAY);
}
btnNight.addEventListener('click', ()=> applyNight(!isNight));

/* ========= RENDER ========= */
function render(){
  requestAnimationFrame(render);
  controls.update();
  composer.render();
  labelRenderer.render(scene, camera);
}
</script>
</body>
</html>

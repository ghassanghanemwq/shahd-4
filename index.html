<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Interactive 3D Map — Luxury Wine Red</title>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.161.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.161.0/examples/jsm/"
  }
}
</script>

<style>
  :root{
    --bg:#0a0a0c; --text:#f3f3f7; --muted:#a8a8b8; --edge:#2a2a34;
    --primary:#8B0E2A; --primary-2:#A01832;

    /* Your legend colors */
    --available:#ffffff;   /* white  */
    --reserved:#9ad8ff;    /* baby blue */
    --sold:#df1a25;        /* red */
  }

  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  #scene{position:fixed;inset:0;background:
    radial-gradient(1400px 700px at 70% 35%, rgba(139,14,42,.12) 0%, rgba(139,14,42,0) 55%),
    radial-gradient(900px 520px at 20% 80%, rgba(160,24,50,.10) 0%, rgba(160,24,50,0) 60%),
    linear-gradient(180deg, #0a0a0c 0%, #0b0b10 50%, #0a0a0c 100%);
  }
  canvas{display:block;width:100%;height:100%}
  #scene::after{content:'';position:absolute;inset:0;pointer-events:none;background:repeating-linear-gradient(transparent 0 2px,rgba(255,255,255,.02) 2px 3px)}
  #scene::before{content:'';position:absolute;inset:0;pointer-events:none;background:radial-gradient(1200px 700px at 50% 50%,transparent 40%,rgba(0,0,0,.35) 100%)}
  #loading{position:absolute;inset:0;display:grid;place-items:center;color:#d6d6e6;letter-spacing:.2em;text-transform:uppercase}

  /* Hover tooltip (only on hover) */
  #label{position:fixed;pointer-events:none;transform:translate(-50%,-120%);padding:6px 10px;background:rgba(15,15,20,.7);
    border:1px solid rgba(139,14,42,.35);border-radius:8px;color:#ffe6ea;font-weight:700;font-size:12px;box-shadow:0 8px 30px rgba(139,14,42,.25);display:none;z-index:6}

  /* Always-on lot labels */
  .lotLabel{
    position:absolute;padding:2px 6px;border:1px solid rgba(255,255,255,.15);border-radius:6px;background:rgba(0,0,0,.65);
    color:#fff;font-weight:700;font-size:11px;letter-spacing:.02em;text-shadow:0 1px 2px rgba(0,0,0,.5);
    pointer-events:none;user-select:none;white-space:nowrap;backdrop-filter:blur(2px);transition:opacity .15s linear;
  }

  /* Legend */
  #legend{position:fixed;left:12px;bottom:12px;display:flex;gap:8px;z-index:5}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#13131b;border:1px solid var(--edge);color:#d1d1dc}
  .chip::before{content:'';width:8px;height:8px;border-radius:50%}
  .chip.avail::before{background:var(--available)}
  .chip.resv::before{background:var(--reserved)}
  .chip.sold::before{background:var(--sold)}

  /* Search */
  #searchWrap{position:fixed;top:16px;right:480px;z-index:7;width:min(420px,50vw)}
  #search{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #292937;background:#101018;color:var(--text);outline:none;
    box-shadow:0 0 0 0 rgba(139,14,42,0),0 12px 24px rgba(0,0,0,.25);transition:box-shadow .2s ease,border-color .2s ease}
  #search::placeholder{color:#8f8fa4}
  #search:focus{border-color:rgba(139,14,42,.55);box-shadow:0 0 0 3px rgba(139,14,42,.15),0 20px 50px rgba(139,14,42,.15)}
  #results{position:absolute;top:50px;left:0;right:0;background:#0f0f16;border:1px solid #262636;border-radius:12px;overflow:auto;max-height:42vh;box-shadow:0 22px 40px rgba(0,0,0,.45);display:none}
  .result{display:flex;align-items:center;gap:10px;padding:12px 14px;cursor:pointer;color:#f1dbe0}
  .result:hover{background:#151520;box-shadow:inset 0 0 0 1px rgba(139,14,42,.25)}
  .badge{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid #3a3a4a;color:#f6c9cf;background:#1a1214;margin-left:auto}

  /* Drawer */
  #drawer{position:fixed;top:0;right:0;bottom:0;width:380px;background:linear-gradient(180deg,rgba(20,14,18,.85) 0%,rgba(10,10,14,.92) 100%);
    backdrop-filter:blur(10px);border-left:1px solid #1e1e28;box-shadow:-10px 0 28px rgba(0,0,0,.4);transform:translateX(100%);transition:transform .38s cubic-bezier(.2,.8,.2,1);z-index:6;overflow:auto}
  #drawer.open{transform:translateX(0)}
  #drawer header{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid #222230;position:sticky;top:0;background:rgba(20,15,20,.8)}
  #drawer header .title{font-weight:800;letter-spacing:.02em}
  #content{padding:16px}
  .row{display:grid;grid-template-columns:110px 1fr;gap:10px;margin:10px 0}
  .thumb{width:100%;border-radius:14px;border:1px solid #272734;background:#111118}
  .muted{color:var(--muted)}
  .ghost{width:100%;padding:12px 14px;border:1px solid #2a2a38;border-radius:12px;background:transparent;color:var(--text);font-weight:700;cursor:pointer}
  .primary{width:100%;padding:12px 14px;border:0;border-radius:12px;background:linear-gradient(180deg,var(--primary),var(--primary-2));color:#1b0a0f;font-weight:900;cursor:pointer;box-shadow:0 12px 30px rgba(139,14,42,.25);text-transform:uppercase;letter-spacing:.03em}
  .ghost,.primary{transition:transform .2s cubic-bezier(.2,.8,.2,1),box-shadow .25s ease,filter .25s ease}
  .ghost:hover{transform:translateY(-1px)}.ghost:active{transform:translateY(0)}
  .primary:hover{transform:translateY(-1px);box-shadow:0 14px 36px rgba(139,14,42,.26)}.primary:active{transform:translateY(0);filter:brightness(.98)}
</style>
</head>
<body>
  <div id="scene">
    <div id="loading">LOADING… 0%</div>
    <canvas id="c"></canvas>
    <div id="label"></div>
    <div id="legend">
      <span class="chip avail">Available</span>
      <span class="chip resv">Reserved</span>
      <span class="chip sold">Sold</span>
    </div>
  </div>

  <!-- Search -->
  <div id="searchWrap">
    <input id="search" placeholder="Search lot (e.g. 012 or Lot_012)" />
    <div id="results"></div>
  </div>

  <!-- Drawer -->
  <aside id="drawer">
    <header>
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 11h18M5 19h14M7 5h10" stroke="#8B0E2A" stroke-width="1.6" stroke-linecap="round"/></svg>
      <div class="title">Parcel Details</div>
    </header>
    <div id="content">
      <p class="muted">Click a lot or use search.</p>
      <img id="thumb" class="thumb" alt="Lot preview" />
      <div class="row"><div class="muted">Lot</div><div id="lotId">—</div></div>
      <div class="row"><div class="muted">Area</div><div id="area">—</div></div>
      <div class="row"><div class="muted">Price</div><div id="price">—</div></div>
      <div class="row"><div class="muted">Status</div><div id="status"><span class="chip">—</span></div></div>
      <div class="row"><div class="muted">Description</div><div id="notes">—</div></div>
      <div class="row" style="grid-template-columns:1fr 1fr">
        <button id="brochureBtn" class="ghost">Open Brochure</button>
        <button id="inquireBtn" class="primary">Inquire</button>
      </div>
    </div>
  </aside>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
import { KTX2Loader } from 'three/addons/loaders/KTX2Loader.js';
import { MeshoptDecoder } from 'three/addons/libs/meshopt_decoder.module.js';
import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

/* ========= CONFIG ========= */
const CONFIG = { glbUrl:'./map.glb', highlight:0x8B0E2A };

/* ========= DATA ========= */
let RAW = {}, LOTS = {}, INDEX = [];
fetch('lots.json').then(r=>r.json()).then(d=>{ RAW=d||{}; normalize(); }).catch(()=>{});

/* ========= DOM ========= */
const canvas = document.getElementById('c');
const loading = document.getElementById('loading');
const label   = document.getElementById('label');
const drawer  = document.getElementById('drawer');
const lotIdEl = document.getElementById('lotId');
const areaEl  = document.getElementById('area');
const priceEl = document.getElementById('price');
const statusEl= document.getElementById('status');
const notesEl = document.getElementById('notes');
const thumbEl = document.getElementById('thumb');
const brochureBtn = document.getElementById('brochureBtn');
const inquireBtn  = document.getElementById('inquireBtn');
const search = document.getElementById('search');
const results = document.getElementById('results');

/* ========= THREE ========= */
const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
renderer.setPixelRatio(Math.min(devicePixelRatio, 1.8));
renderer.setSize(innerWidth, innerHeight);
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 0.95;

const scene = new THREE.Scene();
const pmrem = new THREE.PMREMGenerator(renderer);
scene.environment = pmrem.fromScene(new RoomEnvironment(renderer), 0.03).texture;
scene.fog = new THREE.FogExp2(0x0b0b10, 0.0009);

const camera = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.1, 4000);

/* Orbit lock: never dip below */
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.maxPolarAngle = Math.PI * 0.49;
controls.minPolarAngle = 0.28;
controls.enablePan = false;

/* Lights & ground */
const key = new THREE.DirectionalLight(0xffffff,1.05); key.position.set(2,4,1); scene.add(key);
const fillR = new THREE.DirectionalLight(0xff4040,0.18); fillR.position.set(-3,2,-2); scene.add(fillR);
const rim = new THREE.DirectionalLight(0xffffff,0.22); rim.position.set(0,5,-4); scene.add(rim);
scene.add(new THREE.AmbientLight(0xffffff,0.33));
const ground = new THREE.Mesh(new THREE.PlaneGeometry(2000,2000), new THREE.MeshStandardMaterial({color:0x0b0b10, roughness:.95}));
ground.rotation.x = -Math.PI/2; ground.position.y=-0.02; scene.add(ground);
const grid = new THREE.GridHelper(1200, 80, 0x26090E, 0x140508); grid.position.y=-0.019; grid.material.opacity=0.12; grid.material.transparent=true; scene.add(grid);

/* Post FX */
const composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
const bloom = new UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 0.5, 0.85, 0.2);
bloom.threshold = 0.35; bloom.strength = 0.15; bloom.radius = 0.2;
composer.addPass(bloom);

/* CSS2D labels overlay */
const labelRenderer = new CSS2DRenderer();
labelRenderer.setSize(innerWidth, innerHeight);
labelRenderer.domElement.style.position = 'fixed';
labelRenderer.domElement.style.inset = '0';
labelRenderer.domElement.style.pointerEvents = 'none';
document.body.appendChild(labelRenderer.domElement);

const ray = new THREE.Raycaster();
const mouse = new THREE.Vector2();
let GLB, hovered, selected;

/* id -> { node: CSS2DObject, center: Vector3 } */
const LOT_LABELS = new Map();

/* ========= HELPERS ========= */
const pad3 = n => String(n).padStart(3,'0');
const normId = n => `Lot_${pad3(n)}`;

/* Extract lot number from ANY object name:
   - handles collection paths "Layer/Lot_149.001"
   - accepts variants "Lot-149a", "lot 149", "LOT_0149.003"
   - ignores non-lot names like "grass", "road"
*/
function extractLotNumber(name){
  if(!name) return null;
  // take last path segment if there are folders/pipes
  const base = name.split(/[\\/|]/).pop();
  // strip common suffixes like ".001"
  const clean = base.replace(/\.\d+$/,'');
  // find "lot" followed by optional separators and digits (1-4 digits)
  const m = clean.match(/lot[\s_\-]*0*(\d{1,4})/i);
  return m ? m[1] : null;
}

function fit(root){
  const box = new THREE.Box3().setFromObject(root);
  const c = box.getCenter(new THREE.Vector3());
  const s = box.getSize(new THREE.Vector3());
  const r = Math.max(s.x,s.y,s.z)*0.6;
  const dir = new THREE.Vector3(1,0.8,1).normalize();
  camera.position.copy(c.clone().add(dir.multiplyScalar(r*2.3)));
  controls.target.copy(c); controls.minDistance=r*0.2; controls.maxDistance=r*10;
  camera.near=Math.max(0.1,r/100); camera.far=r*100; camera.updateProjectionMatrix(); controls.update();
}

function pick(x,y){
  mouse.set((x/canvas.clientWidth)*2-1, -(y/canvas.clientHeight)*2+1);
  ray.setFromCamera(mouse, camera);
  const hits = ray.intersectObjects(GLB?GLB.children:[], true);
  const hit = hits.find(h=> extractLotNumber(h.object?.name||'') !== null );
  return hit ? hit.object : null;
}

function normalize(){
  LOTS = {};
  for(const [k,v] of Object.entries(RAW)){
    const n = extractLotNumber(k);
    if(!n) continue;
    const id = normId(n);
    LOTS[id]=v; LOTS[n]=v;
  }
  buildIndex();
}

function buildIndex(){
  INDEX = []; const seen=new Set();

  // from lots.json
  Object.keys(RAW).forEach(k=>{
    const n = extractLotNumber(k); if(!n) return;
    const id = normId(n); if(!seen.has(id)){ INDEX.push({id}); seen.add(id); }
  });

  // from GLB
  if(GLB){
    GLB.traverse(o=>{
      if(!o.isMesh || !o.name) return;
      const n = extractLotNumber(o.name); if(!n) return;
      const id = normId(n);
      if(!seen.has(id)){ INDEX.push({id}); seen.add(id); }
    });
  }

  INDEX.sort((a,b)=>a.id.localeCompare(b.id,undefined,{numeric:true}));
}

function openDrawer(){ drawer.classList.add('open'); }

function setHover(o){
  if(hovered===o) return;
  if(hovered?.material){ hovered.material.emissive?.set(0); hovered.material.emissiveIntensity=0; }
  hovered=o;
  if(hovered?.material){ hovered.material.emissive?.setHex(CONFIG.highlight); hovered.material.emissiveIntensity=.10; }
}

function setSelected(o){
  if(selected?.material){ selected.material.emissive?.set(0); selected.material.emissiveIntensity=0; }
  selected=o;
  if(selected?.material){ selected.material.emissive?.setHex(CONFIG.highlight); selected.material.emissiveIntensity=.22; }
  if(selected) showDetails(selected.name);
}

function showDetails(name){
  const n = extractLotNumber(name);
  const display = n ? normId(n) : name;
  const data = LOTS[display] || LOTS[n || ''];
  openDrawer();
  lotIdEl.textContent = display.replace(/^lot_/i,'');
  if(!data){
    areaEl.textContent=priceEl.textContent='—';
    statusEl.innerHTML='<span class="chip">No data</span>';
    notesEl.textContent=`Add to lots.json: "${display}"`;
    thumbEl.style.display='none';
    brochureBtn.onclick=inquireBtn.onclick=null; return;
  }
  areaEl.textContent  = data.area ? `${Number(data.area).toLocaleString()} ${data.unit||'m²'}` : '—';
  priceEl.textContent = data.price ? `$${Number(data.price).toLocaleString()}` : '—';
  const s=(data.status||'').toLowerCase();
  const chip=document.createElement('span'); chip.className='chip '+(s.startsWith('ava')?'avail':s.startsWith('res')?'resv':s.startsWith('sold')?'sold':''); chip.textContent=s?s[0].toUpperCase()+s.slice(1):'—';
  statusEl.innerHTML=''; statusEl.appendChild(chip);
  notesEl.textContent = data.notes || '—';
  if(data.thumb){ thumbEl.src=data.thumb; thumbEl.style.display='block'; } else { thumbEl.style.display='none'; }
  brochureBtn.onclick = ()=> data.brochure ? window.open(data.brochure,'_blank') : null;
  inquireBtn.onclick  = ()=> data.link ? window.open(data.link,'_blank') : window.open('mailto:sales@example.com?subject=Inquiry%20'+encodeURIComponent(display));
}

function focusLot(idOrName){
  const n = extractLotNumber(idOrName);
  const lotId = n ? normId(n) : null;
  if(!lotId){ alert('Lot not found: '+idOrName); return; }

  const info = LOT_LABELS.get(lotId);
  if(info){
    const c = info.center;
    controls.target.copy(c);
    camera.position.copy(c.clone().add(new THREE.Vector3(1,0.85,1).normalize().multiplyScalar(18)));
    controls.update();
    const obj = GLB.getObjectByName(lotId) || GLB.getObjectByName(lotId.replace(/^Lot_/,''));
    if(obj) setSelected(obj);
    return;
  }

  const obj = GLB.getObjectByName(lotId);
  if(!obj){ alert('Lot not found: '+lotId); return; }
  const box=new THREE.Box3().setFromObject(obj), c=box.getCenter(new THREE.Vector3()), s=box.getSize(new THREE.Vector3()).length();
  controls.target.copy(c);
  camera.position.copy(c.clone().add(new THREE.Vector3(1,0.85,1).normalize().multiplyScalar(Math.max(6, s*1.8))));
  controls.update();
  setSelected(obj);
}

/* Recolor lots from lots.json using your palette */
function recolorByStatus(){
  if(!GLB) return;
  GLB.traverse(o=>{
    const n = extractLotNumber(o.name); if(!o.isMesh || !n) return;
    const id = normId(n);
    const d=LOTS[id] || LOTS[n];
    const mat=(o.material && o.material.clone()) || new THREE.MeshStandardMaterial();
    if(d?.status){
      const s = String(d.status).toLowerCase();
      if(s.startsWith('sold'))      mat.color.set('#df1a25');     // red
      else if(s.startsWith('res'))  mat.color.set('#9ad8ff');     // baby blue
      else                          mat.color.set('#ffffff');     // available = white
      mat.metalness = 0.06; mat.roughness = 0.6;
    }
    o.material = mat;
  });
}

/* ===== Always-on labels: 1 per lot number (unioned) ===== */
function createPermanentLabels(){
  if(!GLB) return;

  LOT_LABELS.forEach(({node})=> node.parent?.remove(node));
  LOT_LABELS.clear();

  const unions = new Map(); // id -> Box3
  GLB.traverse(o=>{
    if(!o.isMesh || !o.name) return;
    const n = extractLotNumber(o.name); if(!n) return;
    const id = normId(n);
    const box = new THREE.Box3().setFromObject(o);
    const u = unions.get(id) || new THREE.Box3();
    u.union(box);
    unions.set(id, u);
  });

  unions.forEach((box, id)=>{
    const center = box.getCenter(new THREE.Vector3());
    const size = box.getSize(new THREE.Vector3());

    const el = document.createElement('div');
    el.className = 'lotLabel';
    el.textContent = id.replace('Lot_',''); // 3-digit only
    el.style.opacity = '1';

    const css = new CSS2DObject(el);
    css.position.set(center.x, center.y + Math.max(size.y*0.05, 1.0), center.z);
    scene.add(css);

    LOT_LABELS.set(id, { node: css, center });
  });
}

/* Fade labels when very close */
function updateLabelOpacity(){
  const d = camera.position.distanceTo(controls.target);
  const t0 = 15, t1 = 40;
  const k = THREE.MathUtils.clamp((d - t0) / (t1 - t0), 0, 1);
  const opacity = 0.2 + 0.8 * k;
  LOT_LABELS.forEach(({node})=>{
    if(node.element) node.element.style.opacity = String(opacity);
  });
}

/* ========= LOAD GLB ========= */
const resolvedGLB = new URL(CONFIG.glbUrl, location.href).href;
const manager = new THREE.LoadingManager();
manager.onStart = ()=>{ loading.textContent = 'Loading… 0%'; };
manager.onError = (url)=>{ console.warn('Asset failed:', url); };

let progressTimer = setTimeout(()=>{
  loading.textContent = 'Still loading… If this stays, check that\n\n• "map.glb" is next to this HTML\n• Using http(s) not file://\n• No ad-block/firewall is blocking unpkg loaders';
}, 6000);

function createLoader(withExtras=true){
  const L = new GLTFLoader(manager);
  if(withExtras){
    const draco = new DRACOLoader(); draco.setDecoderPath('https://unpkg.com/three@0.161.0/examples/jsm/libs/draco/');
    L.setDRACOLoader(draco);
    L.setKTX2Loader(new KTX2Loader().setTranscoderPath('https://unpkg.com/three@0.161.0/examples/jsm/libs/basis/').detectSupport(renderer));
    L.setMeshoptDecoder(MeshoptDecoder);
  }
  return L;
}
function startRender(){ render(); requestAnimationFrame(()=>loading.remove()); clearTimeout(progressTimer); }
function loadGLB(url){
  const loaderA = createLoader(true);
  loaderA.load(url, (gltf)=>{ GLB=gltf.scene; afterGLBLoaded(); }, onProgress, (err)=>{
    console.warn('Primary load failed, retrying without KTX2/Draco…', err);
    const loaderB = createLoader(false);
    loaderB.load(url, (gltf)=>{ GLB=gltf.scene; afterGLBLoaded(); }, onProgress, (err2)=>{
      console.error('Failed to load GLB.', err2); loading.textContent = 'Failed to load GLB. Check console.';
    });
  });
}
function onProgress(ev){
  const pct = ev && ev.total ? Math.floor((ev.loaded/ev.total)*100) : 0;
  loading.textContent = 'Loading… ' + pct + '%';
}
function afterGLBLoaded(){
  GLB.traverse(o=>{
    if(!o.isMesh) return;
    if(!o.material || !('color' in o.material)){
      o.material = new THREE.MeshStandardMaterial({color:0xc2c6ce, metalness:.06, roughness:.84});
    }
    if(o.material?.emissive) o.material.emissive.setHex(0x12070a);
  });
  scene.add(GLB);
  fit(GLB);
  buildIndex();
  recolorByStatus();
  createPermanentLabels();
  startRender();
}
try { loadGLB(resolvedGLB); } catch(e){ console.error(e); loading.textContent='Failed to start loader. See console.'; }

/* ========= INTERACTION ========= */
canvas.addEventListener('mousemove', e=>{
  const o = pick(e.clientX, e.clientY); setHover(o);
  if(o){
    const n = extractLotNumber(o.name);
    label.textContent = n ? `Lot ${pad3(n)}` : o.name;
    label.style.left = e.clientX+'px'; label.style.top = e.clientY+'px'; label.style.display='block';
  } else label.style.display='none';
});
canvas.addEventListener('mouseleave', ()=>{ setHover(null); label.style.display='none'; });

// Click zooms like search
canvas.addEventListener('click', e=>{
  const o = pick(e.clientX,e.clientY);
  if(o) focusLot(o.name);
});

window.addEventListener('resize', ()=>{
  camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight); composer.setSize(innerWidth,innerHeight);
  labelRenderer.setSize(innerWidth, innerHeight);
});

// Exposure + label fade with zoom
controls.addEventListener('change', ()=>{
  const d = camera.position.distanceTo(controls.target);
  renderer.toneMappingExposure = THREE.MathUtils.clamp(1.2 - d * 0.015, 0.65, 1.05);
  updateLabelOpacity();
});

/* ========= SEARCH ========= */
function searchLots(q){
  q=(q||'').trim().toLowerCase(); if(!q) return [];
  const num=q.replace(/[^0-9]/g,'');
  return INDEX.filter(it=>{
    const id=it.id.toLowerCase(), label=id.replace(/^lot_/,'');
    const notes=(RAW[it.id]?.notes||'').toLowerCase();
    return id.includes(q) || (num && label.includes(num)) || notes.includes(q);
  });
}
function showResults(items){
  results.innerHTML=''; if(!items.length){ results.style.display='none'; return; }
  for(const it of items.slice(0,12)){
    const row=document.createElement('div'); row.className='result';
    row.innerHTML=`<strong>${it.id.replace(/^lot_/i,'Lot ')}</strong>`;
    const b=document.createElement('span'); b.className='badge';
    b.textContent=(RAW[it.id]?.status||'').toString().toUpperCase()||'—';
    row.appendChild(b);
    row.onclick=()=>{ focusLot(it.id); results.style.display='none'; };
    results.appendChild(row);
  }
  results.style.display='block';
}
const debounce=(fn,ms=120)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
const debouncedShow=debounce(()=> showResults(searchLots(search.value)), 120);
search.addEventListener('input', debouncedShow);

// Keyboard navigation in search
let selIndex=-1;
search.addEventListener('keydown', (e)=>{
  const items=[...results.querySelectorAll('.result')];
  if(e.key==='Escape'){
    e.preventDefault(); search.value=''; results.style.display='none'; selIndex=-1; search.blur(); return;
  }
  if(e.key==='ArrowDown'){
    e.preventDefault(); if(!items.length) return; selIndex=(selIndex+1)%items.length; items.forEach((el,i)=>el.style.background=i===selIndex?'#151520':'' );
  } else if(e.key==='ArrowUp'){
    e.preventDefault(); if(!items.length) return; selIndex=(selIndex-1+items.length)%items.length; items.forEach((el,i)=>el.style.background=i===selIndex?'#151520':'' );
  } else if(e.key==='Enter'){
    e.preventDefault(); if(items.length && selIndex>=0){ items[selIndex].click(); selIndex=-1; return; }
    const v=search.value.trim(); const m=v.match(/\d{1,4}/); const id = m?normId(m[0]):v.replace(/\s+/g,'_');
    focusLot(id); results.style.display='none';
  }
});
document.addEventListener('click', (e)=>{
  if(!results.contains(e.target) && e.target!==search) { results.style.display='none'; selIndex=-1; }
});
document.addEventListener('keydown', (e)=>{
  if(e.key==='Escape'){
    if(document.activeElement===search || results.style.display==='block' || search.value){
      search.value=''; results.style.display='none'; selIndex=-1; search.blur();
    }
    return;
  }
  const tag=(e.target||{}).tagName;
  if(tag==='INPUT' || tag==='TEXTAREA' || e.metaKey || e.ctrlKey || e.altKey) return;
  const ch=e.key;
  if(ch==='/' || /^[a-zA-Z0-9]$/.test(ch)){
    search.focus();
    if(ch!=='/' && !search.value) search.value=ch;
    debouncedShow();
  }
});

/* ========= RENDER ========= */
function render(){
  requestAnimationFrame(render);
  controls.update();
  composer.render();
  labelRenderer.render(scene, camera);
}
</script>
</body>
</html>
